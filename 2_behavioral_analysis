# =====================================================================
# ğŸ“Š STEP 3: EXPLORATORY FINANCIAL & BEHAVIORAL ANALYSIS

# Title: Understanding Financial Performance and Customer Behavior
# Author: Maria Figueiredo
# Dataset: Online Retail (UCI Machine Learning Repository)
#
# =====================================================================
# ğŸ¯ OBJECTIVE
# This step transforms the cleaned transactional dataset into actionable insights. 
# Through descriptive statistics and data visualization, we aim to understand the financial performance 
# of the business and the behavior of its customers across time, products, and geography.

# Specifically, this analysis:
#   â–ª Measures key financial KPIs (revenue, AOV, customer value).
#   â–ª Examines geographic and product-level performance.
#   â–ª Detects seasonality, temporal patterns, and customer segmentation clues.
#   â–ª Produces visual assets (charts) for dashboards and reports.

# The goal is to translate raw numbers into clear business insights that support data-driven decision-making.

# =====================================================================
# ğŸ’¡ WHY THIS STEP MATTERS
# Exploratory financial analysis bridges the gap between data preparation and advanced analytics. 
# It reveals trends, relationships, and anomalies that define how a company generates value and how customers behave.

# â–« Financially â†’ identifies the real drivers of revenue and profitability.
# â–« Behaviorally â†’ clarifies how customers purchase, when, and on what.
# â–« Strategically â†’ provides evidence for decisions on pricing, marketing, stock planning, and customer retention.

# Without this step, predictive models would lack context and could lead to misleading conclusions.

# =====================================================================
# ğŸŒ VALUE FOR INDUSTRY AND SOCIETY
# â–« For Businesses:
#     - Enables transparent performance tracking and profitability analysis.
#     - Supports sustainable growth by identifying seasonality and demand cycles.
#     - Highlights customer diversity and opportunities for personalization.

# â–« For Society:
#     - Encourages responsible retail practices and efficient logistics.
#     - Reduces waste by aligning production and demand forecasting.
#     - Promotes data-driven innovation that respects consumer behavior and market transparency.

# =====================================================================
# ğŸ§­ CURRENT STEP
# This script is part of the project â€œFinancial and Behavioral Analysis in E-Commerceâ€. 
# Building on the cleaned dataset from Step 2, it focuses on *exploring* and *visualizing* the data to extract interpretable insights.

# In this step we:
#   1ï¸âƒ£ Load the cleaned dataset created in Step 2.
#   2ï¸âƒ£ Compute core financial metrics (revenue, AOV, customers).
#   3ï¸âƒ£ Visualize results by geography, product, time, and behavior.
#   4ï¸âƒ£ Interpret findings and provide strategic recommendations.

# The outputs â€” figures, metrics, and interpretations â€” form the foundation for predictive modeling in the following steps 
# (RFM, CLV, churn, and demand).

################################################################ 0. Initial Setup ################################################################

import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import os
import warnings
from datetime import datetime

# CONFIGURATION
warnings.filterwarnings("ignore")
sns.set(style="whitegrid")

# == GitHub-Friendly File Paths ==
clean_path = "Online_Retail_CLEAN.csv"
fig_dir = "figures/"

# Ensure required folders exist
os.makedirs("output", exist_ok=True)
os.makedirs(fig_dir, exist_ok=True)

# File existence check (cleaned data must exist from Step 2)
if not os.path.exists(clean_path):
    raise FileNotFoundError(
        f"\nâŒ Cleaned dataset not found: {clean_path}\n"
        f"â¡ï¸ Please run STEP 2 (Data Cleaning) first.\n"
        f"   It will generate the necessary cleaned file inside: output/\n"
    )

# LOAD CLEANED DATASET
df = pd.read_csv(clean_path)

print(f"âœ… Cleaned dataset loaded with {df.shape[0]:,} rows and {df.shape[1]} columns.")
print("Justification: We load the cleaned dataset to ensure that all previous transformations "
      "(TotalPrice and time-based features) are available.\n")

# Helper function to save and show figures
def save_and_show(fig, name):
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    filepath = os.path.join(fig_dir, f"{name}_{timestamp}.png")
    fig.savefig(filepath, dpi=300, bbox_inches='tight')
    plt.show()

################################################################ 1. Initial Analysis ################################################################

# FINANCIAL KPIs
print("ğŸ“ˆ Calculating key financial indicators...")

total_revenue = df['TotalPrice'].sum()
num_transactions = df['InvoiceNo'].nunique()
num_customers = df['CustomerID'].nunique()
avg_order_value = total_revenue / num_transactions
avg_revenue_per_customer = total_revenue / num_customers

print(f"ğŸ’° Total Revenue: Â£{total_revenue:,.2f}")
print(f"ğŸ§¾ Number of Transactions: {num_transactions:,}")
print(f"ğŸ‘¥ Unique Customers: {num_customers:,}")
print(f"ğŸ›ï¸ Average Order Value (AOV): Â£{avg_order_value:,.2f}")
print(f"ğŸ“Š Average Revenue per Customer: Â£{avg_revenue_per_customer:,.2f}\n")

# FIGURE: Top10 Countries Revenues
print("ğŸ“Š Generating figure: Top10 Countries Revenues...")

country_revenue = (
    df.groupby('Country')['TotalPrice']
    .sum()
    .sort_values(ascending=False)
    .head(10)
)

fig, ax = plt.subplots(figsize=(10,6))
sns.barplot(x=country_revenue.values, y=country_revenue.index, palette=sns.color_palette("Blues", n_colors=10), ax=ax)
ax.set_title("Top10 Countries Revenues")
ax.set_xlabel("Total Revenue (Â£)")
ax.set_ylabel("Country")
plt.tight_layout()
save_and_show(fig, "Top10_Countries_Revenues")

# Figure 1. Analytical Interpretation: Top10 Countries Revenues
print("\nğŸ” Analytical Interpretation: Top10 Countries Revenues\n")
print("""
1ï¸âƒ£ The United Kingdom dominates total sales, revealing strong domestic performance but also high dependency risk.
2ï¸âƒ£ Secondary European markets (Netherlands, Ireland, Germany, France) show growth potential.
3ï¸âƒ£ Non-European sales (e.g., Australia) are residual â€” expansion could reduce geographic concentration.
ğŸ’¡ Strategic Insight:
Pursue regional diversification through localized campaigns and partnerships.
""")

# FIGURE: Top10 Products Revenues
print("\nğŸ“Š Generating figure: Top10 Products Revenues...")

product_revenue = (
    df.groupby('Description')['TotalPrice']
    .sum()
    .sort_values(ascending=False)
    .head(10)
)

fig, ax = plt.subplots(figsize=(10,6))
sns.barplot(x=product_revenue.values, y=product_revenue.index, palette=sns.color_palette("Greens", n_colors=10), ax=ax)
ax.set_title("Top10 Products Revenues")
ax.set_xlabel("Total Revenue (Â£)")
ax.set_ylabel("Product Description")
plt.tight_layout()
save_and_show(fig, "Top10_Products_Revenues")

# Figure 2. Analytical Interpretation: Top10 Products Revenues
print("\nğŸ” Analytical Interpretation: Top10 Products Revenues\n")
print("""
1ï¸âƒ£ The store thrives in 'home & gifts' â€” decorative items lead sales.
2ï¸âƒ£ A few high-margin products drive most revenue (Pareto principle).
3ï¸âƒ£ Smaller products can support cross-selling and loyalty strategies.
ğŸ’¡ Strategic Insight:
Focus on optimizing inventory and promotions for top-performing SKUs.
""")

# FIGURE: Monthly Revenue Trend
print("\nğŸ“Š Generating figure: Monthly Revenue Trend...")

monthly_revenue = (
    df.groupby(['InvoiceYear', 'InvoiceMonth'])['TotalPrice']
    .sum()
    .reset_index()
)
monthly_revenue['YearMonth'] = (
    monthly_revenue['InvoiceYear'].astype(str) + "-" +
    monthly_revenue['InvoiceMonth'].astype(str).str.zfill(2)
)

fig, ax = plt.subplots(figsize=(12,6))
sns.lineplot(data=monthly_revenue, x='YearMonth', y='TotalPrice', marker='o', color='royalblue', ax=ax)
ax.set_title("Monthly Revenue Trend")
ax.set_xlabel("Month")
ax.set_ylabel("Total Revenue (Â£)")
plt.xticks(rotation=45)
plt.tight_layout()
save_and_show(fig, "Monthly_Revenue_Trend")

# Figure 3. Analytical Interpretation: Monthly Revenue Trend
print("\nğŸ” Analytical Interpretation: Monthly Revenue Trend\n")
print("""
1ï¸âƒ£ Revenue grows steadily across the year with a sharp Q4 peak.
2ï¸âƒ£ Strong seasonal impact from holidays (Black Friday, Christmas).
3ï¸âƒ£ Drop in December shows post-holiday slowdown.
ğŸ’¡ Strategic Insight:
Plan campaigns and logistics around Q4 peaks for maximum efficiency.
""")

# FIGURE: Customer Spending Distribution
print("\nğŸ“Š Generating figure: Customer Spending Distribution...")

customer_spending = (
    df.groupby('CustomerID')['TotalPrice']
    .sum()
    .reset_index()
    .rename(columns={'TotalPrice': 'TotalSpent'})
)

fig, ax = plt.subplots(figsize=(12,6))
sns.histplot(customer_spending['TotalSpent'], bins=50, kde=True, color='darkorange', ax=ax)
ax.set_title("Customer Spending Distribution")
ax.set_xlabel("Total Spent (Â£)")
ax.set_ylabel("Number of Customers")
plt.tight_layout()
save_and_show(fig, "Customer_Spending_Distribution")

# Figure 4. Analytical Interpretation: Customer Spending Distribution
print("\nğŸ” Analytical Interpretation: Customer Spending Distribution\n")
print("""
1ï¸âƒ£ Most customers spend small amounts, a few spend heavily (Pareto pattern).
2ï¸âƒ£ Indicates dependency on high-value customers.
3ï¸âƒ£ Highlights opportunity for loyalty programs and targeted retention.
ğŸ’¡ Strategic Insight:
Invest in retention of top spenders and engagement of low-value buyers.
""")

# FIGURE: Revenue by Day of the Week
print("\nğŸ“Š Generating figure: Revenue by Day of the Week...")

weekday_revenue = (
    df.groupby('InvoiceWeekday')['TotalPrice']
    .sum()
    .reindex(['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'])
)

fig, ax = plt.subplots(figsize=(10,5))
sns.barplot(x=weekday_revenue.index, y=weekday_revenue.values, palette=sns.color_palette("Purples", n_colors=7), ax=ax)
ax.set_title("Revenue by Day of the Week")
ax.set_xlabel("Weekday")
ax.set_ylabel("Total Revenue (Â£)")
plt.tight_layout()
save_and_show(fig, "Revenue_By_Weekday")

# Figure 5. Analytical Interpretation: Revenue by Day of the Week
print("\nğŸ” Analytical Interpretation: Revenue by Day of the Week\n")
print("""
1ï¸âƒ£ Revenue peaks mid-week (especially Thursday).
2ï¸âƒ£ Lower weekend sales reveal professional or routine-based buying.
3ï¸âƒ£ Suggests opportunity for weekend promotions to boost engagement.
ğŸ’¡ Strategic Insight:
Align campaigns with mid-week peaks and test weekend strategies.
""")

################################################################ 2. Data Interpretation ################################################################

# ğŸ§¾ FINAL CONCLUSION & EXECUTIVE SUMMARY
print("\nğŸ“Š FINAL CONCLUSION & EXECUTIVE SUMMARY\n")
print("""
ğŸ”¹ OVERVIEW
The analysis reveals a business with strong domestic dominance, seasonal sales peaks,
and a customer base following a Pareto distribution â€” few high-value clients drive most revenue.

ğŸŒ GEOGRAPHY
- UK drives >80% of total sales â€” strong but risky dependence.
- Expansion in Europe could diversify income streams.

ğŸ›ï¸ PRODUCTS
- Home & gift items dominate; few SKUs account for most sales.
- Prioritize inventory, marketing, and pricing around top products.

ğŸ“ˆ TIME
- Revenue peaks in Q4 (Octâ€“Nov), reflecting strong holiday seasonality.
- Strategic planning around these peaks can improve performance.

ğŸ‘¥ CUSTOMERS
- Few customers generate most revenue (Pareto effect).
- Loyalty and personalization are key to retention and profitability.

ğŸ“… BEHAVIOR
- Thursday is the top revenue day; weekends underperform.
- Suggests potential for new weekend-focused campaigns.

ğŸ’¡ STRATEGIC TAKEAWAYS
1ï¸âƒ£ Diversify geographic markets.
2ï¸âƒ£ Optimize inventory for high-performing SKUs.
3ï¸âƒ£ Focus marketing on high-value customer retention.
4ï¸âƒ£ Strengthen Q4 campaign preparation and logistics.
5ï¸âƒ£ Balance weekly sales patterns through promotional experimentation.

âœ… FINAL REMARK
This analysis provides a foundation for RFM segmentation, CLV modeling,
and predictive forecasting â€” essential next steps to enhance business intelligence
and strategic decision-making.

""")
print("\nâœ… All visuals generated and saved successfully in the 'figures' folder.")
